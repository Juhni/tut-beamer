% `beamerthemetut.sty' provides a beamer theme more or less compliant
% with the TUT PowerPoint slides.
% Newest versions available under https://github.com/tvalimaki/tut-beamer
%
% The theme is based on the work of Benjamin Weiss that can be found on
% https://github.com/hsrmbeamertheme/hsrmbeamertheme
%
% Author: Tuomas Välimäki (18 November 2014)
%         tuomas.s.valimaki@tut.fi
%
% This file may be distributed and/or modified under the GNU Public License.
% http://www.gnu.org/licenses/gpl-3.0.en.html

\ProvidesPackage{beamerthemetut}

\RequirePackage{arev}
\RequirePackage[T1]{fontenc} 
\RequirePackage[utf8]{inputenc}
\RequirePackage{tikz}
\RequirePackage{xpatch}
\RequirePackage{silence}

% Style options
\newif\if@doSectionPage
\@doSectionPagefalse
\DeclareOption{sectionpages}{\@doSectionPagetrue}
\newif\if@languageFinnish
\@languageFinnishfalse
\DeclareOption{finnish}{\@languageFinnishtrue}
\ProcessOptions
\beamer@compresstrue

\mode<presentation>
%---------------------------------------------------------------------
% TOC
%---------------------------------------------------------------------
\useoutertheme[compress=true,subsection=false,shadow]{miniframes}
\setbeamertemplate{section in toc}[sections numbered]
\setbeamertemplate{subsection in toc}[square]

%---------------------------------------------------------------------
% Custom commands
%---------------------------------------------------------------------
\newcommand{\rightTextArrow}{$\rightarrow$}

%---------------------------------------------------------------------
% Itemize
%---------------------------------------------------------------------
\setbeamertemplate{itemize item}{\rightTextArrow}
\setbeamertemplate{itemize subitem}{\rightTextArrow}
\setbeamertemplate{itemize subsubitem}{\rightTextArrow}

\setlength{\parskip}{0.5em}

%---------------------------------------------------------------------
% Colors
%---------------------------------------------------------------------
% Primary presentation colors
\definecolor{WarmGreyDark}{RGB}{70,65,60}
\definecolor{WarmGreyLight}{RGB}{170,165,160}
% Primary colors specified in TUT graphical guidelines
\definecolor{TUTGrey}{RGB}{225,225,225}
\definecolor{TUTBlue}{RGB}{70,200,255}
\definecolor{TUTGreen}{RGB}{180,220,0}
% Secondary colors specified in TUT graphical guidelines
\definecolor{TUTsecOrange}{RGB}{234,103,12}
\definecolor{TUTsecRed}{RGB}{203,0,58}
\definecolor{TUTsecPink}{RGB}{226,0,120}
\definecolor{TUTsecPlum}{RGB}{132,28,128}
\definecolor{TUTsecGreen}{RGB}{0,120,44}
\definecolor{TUTsecPetrol}{RGB}{0,152,172}
\definecolor{TUTsecBlue}{RGB}{0,127,197}
\definecolor{TUTsecDarkblue}{RGB}{0,65,121}
\definecolor{TUTsecDarkred}{RGB}{132,9,43} % TUT-foundation color

% Palettes
\setbeamercolor{palette primary}{fg=WarmGreyDark,bg=TUTBlue}
\setbeamercolor{palette secondary}{fg=WarmGreyDark,bg=TUTGreen}
\setbeamercolor{palette tertiary}{fg=WarmGreyDark,bg=TUTGrey}
\setbeamercolor{palette quaternary}{fg=white,bg=TUTsecGreen}
\setbeamercolor{palette frametitle}{fg=WarmGreyDark}
% General
\setbeamercolor{normal text}{fg=WarmGreyDark}
\setbeamercolor{structure}{fg=TUTsecBlue}
\setbeamercolor{alerted text}{fg=TUTsecRed}
\setbeamercolor{example text}{fg=TUTsecGreen}
\setbeamercolor{copyright text}{fg=WarmGreyLight}
% Titlepage
\setbeamercolor{title}{parent=normal text}
\setbeamercolor{subtitle}{parent=normal text}
\setbeamercolor{date}{parent=palette primary}
\setbeamercolor{author}{parent=palette primary}
\setbeamercolor{email}{parent=palette primary}
\setbeamercolor{institute}{parent=palette primary}
% TOC
\setbeamercolor{section in toc}{parent=normal text}
% Content
\setbeamercolor{frametitle}{parent=palette frametitle}
% Blocks
\setbeamercolor{block title}{use=palette primary,bg=palette primary.bg!50!black,fg=white}
\setbeamercolor{block body}{parent=palette primary}
\setbeamercolor{block title example}{parent=palette quaternary}
\setbeamercolor{block body example}{parent=palette secondary}
\setbeamercolor{block title alerted}{fg=white, bg=TUTsecDarkred}
\setbeamercolor{block body alerted}{fg=white, bg=TUTsecRed}
% Notes
\setbeamercolor{note page}{fg=WarmGreyDark,bg=white}
\setbeamercolor{note title}{use=palette secondary,fg=white,bg=palette secondary.bg}
\setbeamercolor{note date}{parent=note title}
% Page Number
\setbeamercolor{page number in head/foot}{fg=WarmGreyDark}
% Bibliography
\setbeamercolor{bibliography entry author}{fg=WarmGreyDark}
\setbeamercolor{bibliography entry note}{use=bibliography entry author,fg=bibliography entry author.fg!50!white}

%---------------------------------------------------------------------
% Fonts
%---------------------------------------------------------------------
% General
\renewcommand\UrlFont{\rmfamily\bfseries}
% Titlepage
\setbeamerfont{title}{size=\fontsize{20.74}{20.74}}
\setbeamerfont{subtitle}{size=\fontsize{12}{14}}
\setbeamerfont{date}{size=\fontsize{8}{10}}
\setbeamerfont{author}{size=\fontsize{12}{15}}
\setbeamerfont{institute}{size=\fontsize{8}{10}}
\setbeamerfont{email}{size=\fontsize{8}{10}}
% Section
\setbeamerfont{section title}{size=\LARGE}
% Content
\setbeamerfont{frametitle}{size=\large}
\setbeamerfont{copyright text}{size=\tiny}
\setbeamerfont{block title}{series=\bfseries,size=\large}
\setbeamerfont{block title alerted}{series=\bfseries,size=\large}
\setbeamerfont{alerted text}{series=\bfseries}
\setbeamerfont{description item}{series=\bfseries}
% Captions
\setbeamerfont{caption name}{series=\bfseries}

%---------------------------------------------------------------------
% Background
%---------------------------------------------------------------------
% Define a macro to draw the TUT gear
\newcommand\tutgear[2][fill=black]{%
\begin{tikzpicture}[y = #2,x = #2]
\path[nonzero rule, inner sep=0pt, outer sep=0pt, #1]%
  (-0.03871,  0.26461) .. controls (-0.13550,  0.25062) and (-0.21553,  0.18492) .. (-0.24979,  0.09646) --
  ( 0.24980,  0.09646) .. controls ( 0.21579,  0.18423) and ( 0.13675,  0.24959) .. ( 0.04099,  0.26428) --
  ( 0.04093,  0.49830) -- ( 0.09697,  0.49061) --
  ( 0.10735,  0.37796) .. controls ( 0.13032,  0.37146) and ( 0.15242,  0.36295) .. ( 0.17347,  0.35260) --
  ( 0.25668,  0.42940) -- ( 0.30253,  0.39851) --
  ( 0.26236,  0.29263) .. controls ( 0.28336,  0.27384) and ( 0.30231,  0.25284) .. ( 0.31887,  0.22998) --
  ( 0.42851,  0.25879) -- ( 0.45447,  0.21004) --
  ( 0.36929,  0.13544) .. controls ( 0.37889,  0.10934) and ( 0.38581,  0.08194) .. ( 0.38968,  0.05358) --
  ( 0.50000,  0.02761) -- ( 0.50000, -0.02761) --
  ( 0.38968, -0.05357) .. controls ( 0.38581, -0.08194) and ( 0.37889, -0.10934) .. ( 0.36929, -0.13544) --
  ( 0.45447, -0.21002) -- ( 0.42851, -0.25880) --
  ( 0.31887, -0.22999) .. controls ( 0.30231, -0.25284) and ( 0.28336, -0.27383) .. ( 0.26236, -0.29261) --
  ( 0.30253, -0.39852) -- ( 0.25668, -0.42940) --
  ( 0.17347, -0.35260) .. controls ( 0.15242, -0.36295) and ( 0.13032, -0.37147) .. ( 0.10735, -0.37796) --
  ( 0.09697, -0.49061) -- ( 0.04093, -0.49830) --
  ( 0.04102, -0.26426) .. controls ( 0.13907, -0.24921) and ( 0.21958, -0.18104) .. ( 0.25217, -0.09010) --
  (-0.25217, -0.09010) .. controls (-0.21934, -0.18175) and (-0.13784, -0.25027) .. (-0.03875, -0.26461) --
  (-0.03835, -0.49830) -- (-0.09697, -0.49061) --
  (-0.10736, -0.37796) .. controls (-0.13032, -0.37146) and (-0.15243, -0.36295) .. (-0.17347, -0.35259) --
  (-0.25669, -0.42940) -- (-0.30253, -0.39852) --
  (-0.26237, -0.29261) .. controls (-0.28337, -0.27383) and (-0.30232, -0.25284) .. (-0.31887, -0.22999) --
  (-0.42850, -0.25880) -- (-0.45447, -0.21002) --
  (-0.36931, -0.13544) .. controls (-0.37891, -0.10932) and (-0.38580, -0.08194) .. (-0.38969, -0.05357) --
  (-0.50000, -0.02761) -- (-0.50000,  0.02761) --
  (-0.38969,  0.05358) .. controls (-0.38580,  0.08194) and (-0.37891,  0.10933) .. (-0.36931,  0.13544) --
  (-0.45447,  0.21004) -- (-0.42850,  0.25879) --
  (-0.31887,  0.22998) .. controls (-0.30232,  0.25284) and (-0.28337,  0.27384) .. (-0.26237,  0.29263) --
  (-0.30253,  0.39851) -- (-0.25669,  0.42940) --
  (-0.17347,  0.35260) .. controls (-0.15243,  0.36295) and (-0.13032,  0.37146) .. (-0.10736,  0.37796) --
  (-0.09697,  0.49061) -- (-0.03835,  0.49830) -- (-0.03871,  0.26461) -- cycle;
\end{tikzpicture}}

% Title page background
\newcommand\TitleBgImage{%
\begin{tikzpicture}[overlay,remember picture]
% colored upper side beam
\usebeamercolor{palette secondary}
\path[fill=bg,nonzero rule]
    ([yshift=0.45\paperheight] current page.south west) -- +(0,0.47\paperheight) -- +(0.0626\paperheight,0.4614\paperheight) -- +(0.0626\paperheight,0) -- cycle;
% colored bottom half of page
\usebeamercolor{palette primary}
\path[fill=bg,nonzero rule]
    (current page.south west) -- ++(0,0.5544\paperheight) -- +(\paperwidth,0) -- (current page.south east) -- cycle;
% gear-half
\node at ([xshift=-0.047\paperheight]current page.south west) [anchor=center] {\tutgear[fill=white]{1.13\paperheight}};
% logo
\if@languageFinnish
\node at ([shift={(0.0626\paperheight,-0.0626\paperheight)}] current page.north west) [anchor=west] {\includegraphics[height=0.0626\paperheight]{TUTlogo_fi}};
\else
\node at ([shift={(0.0626\paperheight,-0.0626\paperheight)}] current page.north west) [anchor=west] {\includegraphics[height=0.0626\paperheight]{TUTlogo_en}};
\fi
\end{tikzpicture}
}

% Frame background
\newcommand\FrameBgImage{%
\begin{tikzpicture}[overlay,remember picture]
% colored upper side beam
\usebeamercolor{palette secondary}
\path[fill=bg,nonzero rule]
    ([yshift=0.45\paperheight] current page.south west) -- +(0,0.47\paperheight) -- +(0.0626\paperheight,0.4614\paperheight) -- +(0.0626\paperheight,0) -- cycle;
% colored lower side beam
\usebeamercolor{palette primary}
\path[fill=bg,nonzero rule]
    (current page.south west) -- +(0,0.47\paperheight) -- +(0.0626\paperheight,0.4614\paperheight) -- +(0.0626\paperheight,0) -- cycle;
\end{tikzpicture}
}

\newcommand\BgImage{\FrameBgImage}
\usebackgroundtemplate{\BgImage}

%---------------------------------------------------------------------
% Titlepage
%---------------------------------------------------------------------
% Email field
\newtoks\email

% Titlepage structure
\def\maketitle{\ifbeamer@inframe\titlepage\else
\begingroup\renewcommand\BgImage{\TitleBgImage}\frame[plain]{\titlepage}
\endgroup\fi}
\def\titlepage{\usebeamertemplate{title page}}
\setbeamertemplate{title page}
{
	\begin{minipage}[t][.42\paperheight][b]{\textwidth}
	\centering
	\ifx\inserttitle\@empty%
	\else%
		{\usebeamerfont{title}\usebeamercolor[fg]{title}\MakeUppercase{\inserttitle}\par}%
	\fi%
	\ifx\insertsubtitle\@empty%
	\else%
		{\usebeamerfont{subtitle}\usebeamercolor[fg]{subtitle}\insertsubtitle\par}%
	\fi%
	\end{minipage}
  \begin{minipage}[c][.18\paperheight]{\textwidth}
  \centering
  \ifx\insertdate\@empty%
  \else%
    {\usebeamerfont{date}\usebeamercolor[fg]{date}\insertdate\par}%
  \fi% 
  \end{minipage}
	\vfill
	\begin{minipage}[b][.35\paperheight]{\textwidth}
	\centering
	\ifx\insertauthor\@empty%
	\else%
		{\usebeamerfont{author}\usebeamercolor[fg]{author}\insertauthor\par}%
	\fi%
	\ifx\the\email\@empty%
	\else%
	  \vspace*{2mm}
	  {\usebeamerfont{email}\usebeamercolor[fg]{email}\href{mailto:\the\email}{\the\email}\par}
	\fi%
	\vfill
	\ifx\insertinstitute\@empty%
	\else%
		{\usebeamerfont{institute}\usebeamercolor[fg]{institute}\insertinstitute\par}%
	\fi% 
	\vspace*{10mm}
	\end{minipage}
}

%---------------------------------------------------------------------
% Sectionpages
%---------------------------------------------------------------------
\if@doSectionPage
% Insert frame with current outline at beginning of sections
\AtBeginSection[]
{
\begingroup
\begin{frame}{Outline}
\tableofcontents[current]
\end{frame}
\endgroup
}
\fi

%---------------------------------------------------------------------
% Frametitle
%---------------------------------------------------------------------
\setbeamertemplate{frametitle}
{
\vspace*{1mm}
\usebeamerfont{frametitle}\MakeUppercase{\insertframetitle}
}

%---------------------------------------------------------------------
% Footline
%---------------------------------------------------------------------
\usenavigationsymbolstemplate{}
\setbeamertemplate{footline}
{%
\leavevmode%
\begin{beamercolorbox}[wd=0.4\textwidth,ht=0.0726\paperheight,dp=0.01\paperheight,leftskip=0.0726\paperheight]{page number in head/foot}%
\if@languageFinnish
	\includegraphics[height=0.0626\paperheight]{TUTlogo_fi}
\else
	\includegraphics[height=0.0626\paperheight]{TUTlogo_en}
\fi
\end{beamercolorbox}
\hfill%
\begin{beamercolorbox}[wd=0.4\textwidth,ht=0.0726\paperheight,dp=0.01\paperheight,right,rightskip=0.4cm]{page number in head/foot}%
\usebeamerfont{page number in head/foot}%
\insertframenumber\vspace{2ex}%
\end{beamercolorbox}
}%

%---------------------------------------------------------------------
% Captions
%---------------------------------------------------------------------
\setbeamertemplate{caption label separator}{: }

%---------------------------------------------------------------------
% Blocks
%---------------------------------------------------------------------
\setbeamertemplate{block begin}
{
  \setbeamercolor{item}{parent=block body}
  \par\vskip\medskipamount%
  \begin{beamercolorbox}[sep=.5ex,dp=0.6ex,leftskip=0.5ex,rightskip=0.5ex]{block title}
    \usebeamerfont*{block title}\insertblocktitle%
  \end{beamercolorbox}%
  {\parskip0pt\par}%
  {\nointerlineskip\vskip-0.5pt}%
  \usebeamerfont{block body}%
  \begin{beamercolorbox}[sep=.5ex,dp=0.6ex,leftskip=0.5ex,rightskip=0.5ex,vmode]{block body}%
}
\setbeamertemplate{block end}  
{\end{beamercolorbox}\vskip\smallskipamount}

\setbeamertemplate{block alerted begin}
{
  \setbeamercolor{item}{parent=block body alerted}
  \par\vskip\medskipamount%
  \begin{beamercolorbox}[sep=.5ex,dp=0.6ex,leftskip=0.5ex,rightskip=0.5ex]{block title alerted}
    \usebeamerfont*{block title alerted}\insertblocktitle%
  \end{beamercolorbox}%
  {\parskip0pt\par}%
  {\nointerlineskip\vskip-0.5pt}%
  \usebeamerfont{block body alerted}%
  \begin{beamercolorbox}[sep=.5ex,dp=0.6ex,leftskip=0.5ex,rightskip=0.5ex,vmode]{block body alerted}%
}
\setbeamertemplate{block alerted end}
{\end{beamercolorbox}\vskip\smallskipamount}

\setbeamertemplate{block example begin}
{
  \par\vskip\medskipamount%
  \begin{beamercolorbox}[sep=.5ex,dp=0.6ex,leftskip=0.5ex,rightskip=0.5ex]{block title example}
    \usebeamerfont*{block title example}\insertblocktitle%
  \end{beamercolorbox}%
  {\parskip0pt\par}%
  {\nointerlineskip\vskip-0.5pt}%
  \usebeamerfont{block body example}%
  \begin{beamercolorbox}[sep=.5ex,dp=0.6ex,leftskip=0.5ex,rightskip=0.5ex,vmode]{block body example}%
}
\setbeamertemplate{block example end}
{\end{beamercolorbox}\vskip\smallskipamount}

%---------------------------------------------------------------------
% Images
%---------------------------------------------------------------------
\newbox\mytempbox
\newdimen\mytempdimen

% Image with copyright information
\newcommand\includegraphicscopyright[3][]{%
  \leavevmode\vbox{\vskip3pt\raggedright\setbox\mytempbox=\hbox{\includegraphics[#1]{#2}}%
    \mytempdimen=\wd\mytempbox\box\mytempbox\par\vskip1pt%
    \usebeamerfont{copyright text}{\usebeamercolor[fg]{copyright text}{\vbox{\hsize=\mytempdimen#3}}}\vskip3pt%
}}

%---------------------------------------------------------------------
% Bibliography
%---------------------------------------------------------------------
\AtEndPreamble{%
\@ifpackageloaded{biblatex}{%
  \WarningFilter{biblatex}{Patching footnotes failed}

  \setbeamertemplate{bibliography item}{%
    \ifboolexpr{ test {\ifentrytype{book}} or test {\ifentrytype{mvbook}}
      or test {\ifentrytype{collection}} or test {\ifentrytype{mvcollection}}
      or test {\ifentrytype{reference}} or test {\ifentrytype{mvreference}} }
      {\setbeamertemplate{bibliography item}[book]}
      {\ifentrytype{online}
         {\setbeamertemplate{bibliography item}[online]}
         {\setbeamertemplate{bibliography item}[article]}}%
    \usebeamertemplate{bibliography item}}

  \defbibenvironment{bibliography}
    {\list{}
       {\settowidth{\labelwidth}{\usebeamertemplate{bibliography item}}%
        \setlength{\leftmargin}{\labelwidth}%
        \setlength{\labelsep}{\biblabelsep}%
        \addtolength{\leftmargin}{\labelsep}%
        \setlength{\itemsep}{\bibitemsep}%
        \setlength{\parsep}{\bibparsep}}}
    {\endlist}
    {\item}
  }{}
}

\mode
<all>
